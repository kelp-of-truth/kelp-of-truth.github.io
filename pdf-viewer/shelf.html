<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Viewer - Shelf</title>
<style>
body { margin:0; font-family: Arial,sans-serif; }
#file-input { margin:10px; }
#bookshelf {
    display:flex;
    flex-direction:column;
    overflow-y:auto;
    height:90vh;
    padding:10px;
    gap:10px;
}
.book-item {
    display:flex;
    align-items:center;
    gap:10px;
    border:1px solid #ccc;
    padding:8px;
}
.book-item img {
    width:60px;
    height:auto;
    object-fit:contain;
    cursor:pointer;
}
.book-title { font-size:16px; cursor:pointer; flex-grow:1; }
.delete-btn {
    background-color:#e74c3c; color:white; border:none;
    padding:4px 8px; cursor:pointer; border-radius:4px;
}
.delete-btn:hover { background-color:#c0392b; }
.book-title input { font-size:16px; width:100%; }
</style>
</head>
<body>

<input type="file" id="file-input" accept="application/pdf">
<div id="bookshelf"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
// IndexedDB 初期化
function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open("BookshelfDB", 1);
        request.onupgradeneeded = e => {
            const db = e.target.result;
            if(!db.objectStoreNames.contains("books")) {
                db.createObjectStore("books", { keyPath: "id" });
            }
        };
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e.target.error);
    });
}

// 保存
async function saveBook(book) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction("books","readwrite");
        const store = tx.objectStore("books");
        store.put(book);
        tx.oncomplete = () => resolve();
        tx.onerror = e => reject(e.target.error);
    });
}

// 削除
async function deleteBook(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction("books","readwrite");
        const store = tx.objectStore("books");
        store.delete(id);
        tx.oncomplete = () => resolve();
        tx.onerror = e => reject(e.target.error);
    });
}

// 取得
async function getAllBooks() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction("books","readonly");
        const store = tx.objectStore("books");
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = e => reject(e.target.error);
    });
}

const fileInput = document.getElementById("file-input");
const bookshelf = document.getElementById("bookshelf");

// 本棚表示
async function renderBookshelf() {
    const books = await getAllBooks();
    bookshelf.innerHTML = "";
    books.forEach(book => {
        const div = document.createElement("div");
        div.className = "book-item";

        const img = document.createElement("img");
        img.src = book.thumbnail;
        img.addEventListener("click", () => {
            window.location.href = `viewer.html?id=${encodeURIComponent(book.id)}`;
        });

        const titleDiv = document.createElement("div");
        titleDiv.className = "book-title";
        titleDiv.textContent = `${book.title} (${book.pages}ページ)`;
        titleDiv.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "text";
            input.value = book.title;
            titleDiv.innerHTML = "";
            titleDiv.appendChild(input);
            input.focus();
            input.addEventListener("keydown", e => {
                if(e.key==="Enter") {
                    book.title = input.value.trim() || book.title;
                    saveBook(book).then(renderBookshelf);
                }
            });
            input.addEventListener("blur", () => {
                book.title = input.value.trim() || book.title;
                saveBook(book).then(renderBookshelf);
            });
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "削除";
        deleteBtn.addEventListener("click", async () => {
            if(confirm(`「${book.title}」を削除しますか？`)) {
                await deleteBook(book.id);
                renderBookshelf();
            }
        });

        div.appendChild(img);
        div.appendChild(titleDiv);
        div.appendChild(deleteBtn);
        bookshelf.appendChild(div);
    });
}

// PDF追加
fileInput.addEventListener("change", async e => {
    const file = e.target.files[0];
    if(!file || file.type!=="application/pdf") return;

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

    // 1ページ目サムネ
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({scale:0.3});
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    await page.render({canvasContext:canvas.getContext("2d"),viewport}).promise;
    const thumbnail = canvas.toDataURL();

    // ID生成
    const id = crypto.randomUUID();

    const book = { id, title:file.name, thumbnail, pages:pdf.numPages, data: arrayBuffer };
    await saveBook(book);
    renderBookshelf();
});

// 初期表示
renderBookshelf();
</script>
</body>

</html>
