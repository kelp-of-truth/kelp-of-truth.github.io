<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Viewer</title>
<link rel="manifest" href="/manifest.json">
<link rel="shortcut icon" href="icon.png" type="image/png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
::-webkit-scrollbar{
    display: none;
}
@font-face {
    font-family: "IBMPlexSansJP";
    src: url("./IBMPlexSansJP-Regular.woff2") format("woff2");
}
body { margin:0; font-family: "IBMPlexSansJP", "Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W3", "Noto Sans JP" , sans-serif; overflow: hidden; }

/* PDFコンテナ */
#pdf-container {
    position: absolute;
    display:flex;
    flex-direction:row;
    overflow-x:auto;
    scroll-snap-type: x mandatory;
    width:100vw;
    height:fit-content;
    top: 0px;
    bottom: 0px;
    margin-top: auto;
    margin-bottom: auto;
    gap:10px;
    transform: scaleX(-1); /* 見た目右→左 */
}
.pdf-page {
    margin-bottom:auto;
    flex:0 0 100%;
    width:100%;
    height:auto;
    scroll-snap-align:start;
    object-fit:contain;
    transform: scaleX(-1); /* ページも反転して正しく表示 */
}

/* ステータスバー */
#status-bar {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:rgba(0,0,0,0.6);
    color:#fff;
    font-size:16px;
    padding:8px 10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-sizing:border-box;
}
/* メニューバー */
#menu{
    position:fixed;
    top:0px; left:0px;
    width:100%;
    background:rgba(0,0,0,0.6);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:1000;
    padding:8px 10px;
    color: #fff;
}
#bookmark-btn {
    cursor:pointer;
    background:#3498db;
    color:white;
    border:none;
    padding:2px 6px;
    border-radius:4px;
    font-size: 16px;
}

/* ローディング */
#loading {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.9);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:1000;
    flex-direction:column;
    color:white;
    font-size:20px;
}
.loader {
    margin-top:20px;
    width:40px;
    height:40px;
    border:5px solid rgba(255,255,255,0.2);
    border-top-color:white;
    border-radius:50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform:rotate(0deg); }
    100% { transform:rotate(360deg); }
}
#popup {
    position:fixed;
    top:0; left:0;bottom: 0; right:0;
    margin: auto;
    width:256px; height:256px;
    background:rgba(0,0,0,0.8);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:2;
    color:white;
    pointer-events: none;
    flex-direction: column;
    border-radius: 16px;
    transition: opacity 250ms ease-out;
    opacity: 0;
}
#popup p {
    margin-top: 16px;
    text-align: center;
    margin-left: 16px;
    margin-right: 16px;
}
</style>
</head>
<body>

<div id="menu">
    <button style="background-color: transparent;position: absolute;left: 10px;border: unset;" id="back-shelf">
        <svg title="一覧にもどる" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#fff" class="size-6" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
    </button>
    <span id="title"></span>
</div>

<div id="popup">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" width="128" height="128">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
    </svg>
    <p>しおりをはさみました</p>
</div>

<div id="loading">
    PDFを読み込み中…
    <div class="loader"></div>
</div>

<div id="pdf-container"></div>

<div id="status-bar">
    <span id="page-info">0 / 0</span>
    <button id="bookmark-btn">
        <svg style="height: 1.2em;vertical-align:-0.2em;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
        </svg>
        しおりをはさむ
    </button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>

document.querySelector("#back-shelf").addEventListener("click", () => {
    window.location.href = "./shelf.html";
});

const container = document.getElementById("pdf-container");
const pageInfo = document.getElementById("page-info");
const bookmarkBtn = document.getElementById("bookmark-btn");
const loadingDiv = document.getElementById("loading");

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open("BookshelfDB", 1);
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e.target.error);
    });
}

function getBookById(id) {
    return new Promise(async (resolve, reject) => {
        const db = await openDB();
        const tx = db.transaction("books","readonly");
        const store = tx.objectStore("books");
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = e => reject(e.target.error);
    });
}

function saveBookmark(bookId, page) { localStorage.setItem(`bookmark_${bookId}`, page); }
function getBookmark(bookId) {
    const page = parseInt(localStorage.getItem(`bookmark_${bookId}`));
    return isNaN(page) ? null : page;
}
function saveLastPage(bookId, page) { localStorage.setItem(`lastpage_${bookId}`, page); }
function getLastPage(bookId) {
    const page = parseInt(localStorage.getItem(`lastpage_${bookId}`));
    return isNaN(page) ? 1 : page;
}

const bookId = new URLSearchParams(window.location.search).get("id");
if(!bookId) alert("IDが指定されていません");

let pdfDoc = null;
let pagesRendered = [];
let totalPages = 0;
let currentPage = 1;

async function renderPDF() {
    loadingDiv.style.display = "flex";

    const book = await getBookById(bookId);
    if(!book || !book.data) {
        loadingDiv.style.display = "none";
        return alert("PDFが見つかりません");
    }

    document.title = `PDF Viewer - ${book.title}`;
    document.getElementById("title").textContent = book.title;
    pdfDoc = await pdfjsLib.getDocument(book.data).promise;
    totalPages = pdfDoc.numPages;
    container.innerHTML = "";
    pagesRendered = [];

    const bookmarkPage = getBookmark(bookId);
    const lastPage = getLastPage(bookId);
    const startPage = bookmarkPage || lastPage || 1;

    // しおりページまで描画
    for(let i=1;i<=startPage;i++){
        await renderPage(i);
    }

    setTimeout(() => {
        scrollToPage(startPage);
    }, 0);
    updatePage();

    // 残りページを順次描画
    renderRemainingPages(startPage+1);

    loadingDiv.style.display = "none";
}

async function renderPage(pageNum){
    const page = await pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({scale:2});
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    await page.render({canvasContext: canvas.getContext("2d"), viewport}).promise;
    const img = new Image();
    img.src = canvas.toDataURL();
    img.className = "pdf-page";
    container.appendChild(img);
    pagesRendered.push(img);
}

function renderRemainingPages(startPage){
    let current = startPage;
    function next(){
        if(current>totalPages) return;
        renderPage(current).then(()=>{
            current++;
            setTimeout(next,0); // setTimeoutで順次描画
        });
    }
    next();
}

function scrollToPage(pageNum){
    if(pageNum<1) pageNum=1;
    if(pageNum>totalPages) pageNum=totalPages;
    const pageElem = pagesRendered[pageNum-1];
    if(pageElem){
        // ページ中央を画面中央に合わせる
        const pageCenter = pageElem.offsetLeft + pageElem.offsetWidth / 2;
        const containerCenter = container.clientWidth / 2;
        container.scrollLeft = pageCenter - containerCenter;
    }
}

function updatePage(){
    const containerCenter = container.scrollLeft + container.clientWidth/2;
    let closestIndex = 0;
    let minDist = Infinity;
    pagesRendered.forEach((page,index)=>{
        const pageCenter = page.offsetLeft + page.offsetWidth/2;
        const dist = Math.abs(pageCenter - containerCenter);
        if(dist < minDist){
            minDist = dist;
            closestIndex = index;
        }
    });
    currentPage = closestIndex+1;
    pageInfo.textContent = `${currentPage} / ${totalPages}`;
    saveLastPage(bookId, currentPage);
}

container.addEventListener("scroll", updatePage);

bookmarkBtn.addEventListener("click", ()=>{
    saveBookmark(bookId, currentPage);
    document.querySelector("#popup p").innerHTML = `${currentPage}ページ目に<br>しおりをはさみました`;
    document.querySelector("#popup").style.opacity = "1";
    setTimeout(() => {
        document.querySelector("#popup").style.opacity = "0";
    }, 2000);
    // alert(`ページ ${currentPage} をしおりに保存しました`);
});

window.addEventListener("DOMContentLoaded", renderPDF);
</script>
</body>
</html>